// vim: ts=4 sw=4 et

#include "rand.h"
#include <assert.h>
#include <stdint.h>
#include <unistd.h>     // getpid
#include <sys/time.h>   // gettimeofday
#include <sys/random.h> // getentropy
#include <pthread.h>

static pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
static pthread_once_t once = PTHREAD_ONCE_INIT;
static rand_source global = RAND_SOURCE_INITIALIZER;

#define rng_len 607

#ifdef static_assert
static_assert(sizeof(((rand_source *)0)->vec) / sizeof(int64_t) == rng_len,
              "size of rng_cooked and rand_source->vec are not equal");
#endif

static const int64_t rng_cooked[rng_len] = {
	-4181792142133755926LL, -4576982950128230565LL, 1395769623340756751LL,  5333664234075297259LL,
	-6347679516498800754LL, 9033628115061424579LL,  7143218595135194537LL,  4812947590706362721LL,
	7937252194349799378LL,  5307299880338848416LL,  8209348851763925077LL,  -7107630437535961764LL,
	4593015457530856296LL,  8140875735541888011LL,  -5903942795589686782LL, -603556388664454774LL,
	-7496297993371156308LL, 113108499721038619LL,   4569519971459345583LL,  -4160538177779461077LL,
	-6835753265595711384LL, -6507240692498089696LL, 6559392774825876886LL,  7650093201692370310LL,
	7684323884043752161LL,  -8965504200858744418LL, -2629915517445760644LL, 271327514973697897LL,
	-6433985589514657524LL, 1065192797246149621LL,  3344507881999356393LL,  -4763574095074709175LL,
	7465081662728599889LL,  1014950805555097187LL,  -4773931307508785033LL, -5742262670416273165LL,
	2418672789110888383LL,  5796562887576294778LL,  4484266064449540171LL,  3738982361971787048LL,
	-4699774852342421385LL, 10530508058128498LL,    -589538253572429690LL,  -6598062107225984180LL,
	8660405965245884302LL,  10162832508971942LL,    -2682657355892958417LL, 7031802312784620857LL,
	6240911277345944669LL,  831864355460801054LL,   -1218937899312622917LL, 2116287251661052151LL,
	2202309800992166967LL,  9161020366945053561LL,  4069299552407763864LL,  4936383537992622449LL,
	457351505131524928LL,   -8881176990926596454LL, -6375600354038175299LL, -7155351920868399290LL,
	4368649989588021065LL,  887231587095185257LL,   -3659780529968199312LL, -2407146836602825512LL,
	5616972787034086048LL,  -751562733459939242LL,  1686575021641186857LL,  -5177887698780513806LL,
	-4979215821652996885LL, -1375154703071198421LL, 5632136521049761902LL,  -8390088894796940536LL,
	-193645528485698615LL,  -5979788902190688516LL, -4907000935050298721LL, -285522056888777828LL,
	-2776431630044341707LL, 1679342092332374735LL,  6050638460742422078LL,  -2229851317345194226LL,
	-1582494184340482199LL, 5881353426285907985LL,  812786550756860885LL,   4541845584483343330LL,
	-6497901820577766722LL, 4980675660146853729LL,  -4012602956251539747LL, -329088717864244987LL,
	-2896929232104691526LL, 1495812843684243920LL,  -2153620458055647789LL, 7370257291860230865LL,
	-2466442761497833547LL, 4706794511633873654LL,  -1398851569026877145LL, 8549875090542453214LL,
	-9189721207376179652LL, -7894453601103453165LL, 7297902601803624459LL,  1011190183918857495LL,
	-6985347000036920864LL, 5147159997473910359LL,  -8326859945294252826LL, 2659470849286379941LL,
	6097729358393448602LL,  -7491646050550022124LL, -5117116194870963097LL, -896216826133240300LL,
	-745860416168701406LL,  5803876044675762232LL,  -787954255994554146LL,  -3234519180203704564LL,
	-4507534739750823898LL, -1657200065590290694LL, 505808562678895611LL,   -4153273856159712438LL,
	-8381261370078904295LL, 572156825025677802LL,   1791881013492340891LL,  3393267094866038768LL,
	-5444650186382539299LL, 2352769483186201278LL,  -7930912453007408350LL, -325464993179687389LL,
	-3441562999710612272LL, -6489413242825283295LL, 5092019688680754699LL,  -227247482082248967LL,
	4234737173186232084LL,  5027558287275472836LL,  4635198586344772304LL,  -536033143587636457LL,
	5907508150730407386LL,  -8438615781380831356LL, 972392927514829904LL,   -3801314342046600696LL,
	-4064951393885491917LL, -174840358296132583LL,  2407211146698877100LL,  -1640089820333676239LL,
	3940796514530962282LL,  -5882197405809569433LL, 3095313889586102949LL,  -1818050141166537098LL,
	5832080132947175283LL,  7890064875145919662LL,  8184139210799583195LL,  -8073512175445549678LL,
	-7758774793014564506LL, -4581724029666783935LL, 3516491885471466898LL,  -8267083515063118116LL,
	6657089965014657519LL,  5220884358887979358LL,  1796677326474620641LL,  5340761970648932916LL,
	1147977171614181568LL,  5066037465548252321LL,  2574765911837859848LL,  1085848279845204775LL,
	-5873264506986385449LL, 6116438694366558490LL,  2107701075971293812LL,  -7420077970933506541LL,
	2469478054175558874LL,  -1855128755834809824LL, -5431463669011098282LL, -9038325065738319171LL,
	-6966276280341336160LL, 7217693971077460129LL,  -8314322083775271549LL, 7196649268545224266LL,
	-3585711691453906209LL, -5267827091426810625LL, 8057528650917418961LL,  -5084103596553648165LL,
	-2601445448341207749LL, -7850010900052094367LL, 6527366231383600011LL,  3507654575162700890LL,
	9202058512774729859LL,  1954818376891585542LL,  -2582991129724600103LL, 8299563319178235687LL,
	-5321504681635821435LL, 7046310742295574065LL,  -2376176645520785576LL, -7650733936335907755LL,
	8850422670118399721LL,  3631909142291992901LL,  5158881091950831288LL,  -6340413719511654215LL,
	4763258931815816403LL,  6280052734341785344LL,  -4979582628649810958LL, 2043464728020827976LL,
	-2678071570832690343LL, 4562580375758598164LL,  5495451168795427352LL,  -7485059175264624713LL,
	553004618757816492LL,   6895160632757959823LL,  -989748114590090637LL,  7139506338801360852LL,
	-672480814466784139LL,  5535668688139305547LL,  2430933853350256242LL,  -3821430778991574732LL,
	-1063731997747047009LL, -3065878205254005442LL, 7632066283658143750LL,  6308328381617103346LL,
	3681878764086140361LL,  3289686137190109749LL,  6587997200611086848LL,  244714774258135476LL,
	-5143583659437639708LL, 8090302575944624335LL,  2945117363431356361LL,  -8359047641006034763LL,
	3009039260312620700LL,  -793344576772241777LL,  401084700045993341LL,   -1968749590416080887LL,
	4707864159563588614LL,  -3583123505891281857LL, -3240864324164777915LL, -5908273794572565703LL,
	-3719524458082857382LL, -5281400669679581926LL, 8118566580304798074LL,  3839261274019871296LL,
	7062410411742090847LL,  -8481991033874568140LL, 6027994129690250817LL,  -6725542042704711878LL,
	-2971981702428546974LL, -7854441788951256975LL, 8809096399316380241LL,  6492004350391900708LL,
	2462145737463489636LL,  -8818543617934476634LL, -5070345602623085213LL, -8961586321599299868LL,
	-3758656652254704451LL, -8630661632476012791LL, 6764129236657751224LL,  -709716318315418359LL,
	-3403028373052861600LL, -8838073512170985897LL, -3999237033416576341LL, -2920240395515973663LL,
	-2073249475545404416LL, 368107899140673753LL,   -6108185202296464250LL, -6307735683270494757LL,
	4782583894627718279LL,  6718292300699989587LL,  8387085186914375220LL,  3387513132024756289LL,
	4654329375432538231LL,  -292704475491394206LL,  -3848998599978456535LL, 7623042350483453954LL,
	7725442901813263321LL,  9186225467561587250LL,  -5132344747257272453LL, -6865740430362196008LL,
	2530936820058611833LL,  1636551876240043639LL,  -3658707362519810009LL, 1452244145334316253LL,
	-7161729655835084979LL, -7943791770359481772LL, 9108481583171221009LL,  -3200093350120725999LL,
	5007630032676973346LL,  2153168792952589781LL,  6720334534964750538LL,  -3181825545719981703LL,
	3433922409283786309LL,  2285479922797300912LL,  3110614940896576130LL,  -2856812446131932915LL,
	-3804580617188639299LL, 7163298419643543757LL,  4891138053923696990LL,  580618510277907015LL,
	1684034065251686769LL,  4429514767357295841LL,  -8893025458299325803LL, -8103734041042601133LL,
	7177515271653460134LL,  4589042248470800257LL,  -1530083407795771245LL, 143607045258444228LL,
	246994305896273627LL,   -8356954712051676521LL, 6473547110565816071LL,  3092379936208876896LL,
	2058427839513754051LL,  -4089587328327907870LL, 8785882556301281247LL,  -3074039370013608197LL,
	-637529855400303673LL,  6137678347805511274LL,  -7152924852417805802LL, 5708223427705576541LL,
	-3223714144396531304LL, 4358391411789012426LL,  325123008708389849LL,   6837621693887290924LL,
	4843721905315627004LL,  -3212720814705499393LL, -3825019837890901156LL, 4602025990114250980LL,
	1044646352569048800LL,  9106614159853161675LL,  -8394115921626182539LL, -4304087667751778808LL,
	2681532557646850893LL,  3681559472488511871LL,  -3915372517896561773LL, -2889241648411946534LL,
	-6564663803938238204LL, -8060058171802589521LL, 581945337509520675LL,   3648778920718647903LL,
	-4799698790548231394LL, -7602572252857820065LL, 220828013409515943LL,   -1072987336855386047LL,
	4287360518296753003LL,  -4633371852008891965LL, 5513660857261085186LL,  -2258542936462001533LL,
	-8744380348503999773LL, 8746140185685648781LL,  228500091334420247LL,   1356187007457302238LL,
	3019253992034194581LL,  3152601605678500003LL,  -8793219284148773595LL, 5559581553696971176LL,
	4916432985369275664LL,  -8559797105120221417LL, -5802598197927043732LL, 2868348622579915573LL,
	-7224052902810357288LL, -5894682518218493085LL, 2587672709781371173LL,  -7706116723325376475LL,
	3092343956317362483LL,  -5561119517847711700LL, 972445599196498113LL,   -1558506600978816441LL,
	1708913533482282562LL,  -2305554874185907314LL, -6005743014309462908LL, -6653329009633068701LL,
	-483583197311151195LL,  2488075924621352812LL,  -4529369641467339140LL, -4663743555056261452LL,
	2997203966153298104LL,  1282559373026354493LL,  240113143146674385LL,   8665713329246516443LL,
	628141331766346752LL,   -4651421219668005332LL, -7750560848702540400LL, 7596648026010355826LL,
	-3132152619100351065LL, 7834161864828164065LL,  7103445518877254909LL,  4390861237357459201LL,
	-4780718172614204074LL, -319889632007444440LL,  622261699494173647LL,   -3186110786557562560LL,
	-8718967088789066690LL, -1948156510637662747LL, -8212195255998774408LL, -7028621931231314745LL,
	2623071828615234808LL,  -4066058308780939700LL, -5484966924888173764LL, -6683604512778046238LL,
	-6756087640505506466LL, 5256026990536851868LL,  7841086888628396109LL,  6640857538655893162LL,
	-8021284697816458310LL, -7109857044414059830LL, -1689021141511844405LL, -4298087301956291063LL,
	-4077748265377282003LL, -998231156719803476LL,  2719520354384050532LL,  9132346697815513771LL,
	4332154495710163773LL,  -2085582442760428892LL, 6994721091344268833LL,  -2556143461985726874LL,
	-8567931991128098309LL, 59934747298466858LL,    -3098398008776739403LL, -265597256199410390LL,
	2332206071942466437LL,  -7522315324568406181LL, 3154897383618636503LL,  -7585605855467168281LL,
	-6762850759087199275LL, 197309393502684135LL,   -8579694182469508493LL, 2543179307861934850LL,
	4350769010207485119LL,  -4468719947444108136LL, -7207776534213261296LL, -1224312577878317200LL,
	4287946071480840813LL,  8362686366770308971LL,  6486469209321732151LL,  -5605644191012979782LL,
	-1669018511020473564LL, 4450022655153542367LL,  -7618176296641240059LL, -3896357471549267421LL,
	-4596796223304447488LL, -6531150016257070659LL, -8982326463137525940LL, -4125325062227681798LL,
	-1306489741394045544LL, -8338554946557245229LL, 5329160409530630596LL,  7790979528857726136LL,
	4955070238059373407LL,  -4304834761432101506LL, -6215295852904371179LL, 3007769226071157901LL,
	-6753025801236972788LL, 8928702772696731736LL,  7856187920214445904LL,  -4748497451462800923LL,
	7900176660600710914LL,  -7082800908938549136LL, -6797926979589575837LL, -6737316883512927978LL,
	4186670094382025798LL,  1883939007446035042LL,  -414705992779907823LL,  3734134241178479257LL,
	4065968871360089196LL,  6953124200385847784LL,  -7917685222115876751LL, -7585632937840318161LL,
	-5567246375906782599LL, -5256612402221608788LL, 3106378204088556331LL,  -2894472214076325998LL,
	4565385105440252958LL,  1979884289539493806LL,  -6891578849933910383LL, 3783206694208922581LL,
	8464961209802336085LL,  2843963751609577687LL,  3030678195484896323LL,  -4429654462759003204LL,
	4459239494808162889LL,  402587895800087237LL,   8057891408711167515LL,  4541888170938985079LL,
	1042662272908816815LL,  -3666068979732206850LL, 2647678726283249984LL,  2144477441549833761LL,
	-3417019821499388721LL, -2105601033380872185LL, 5916597177708541638LL,  -8760774321402454447LL,
	8833658097025758785LL,  5970273481425315300LL,  563813119381731307LL,   -6455022486202078793LL,
	1598828206250873866LL,  -4016978389451217698LL, -2988328551145513985LL, -6071154634840136312LL,
	8469693267274066490LL,  125672920241807416LL,   -3912292412830714870LL, -2559617104544284221LL,
	-486523741806024092LL,  -4735332261862713930LL, 5923302823487327109LL,  -9082480245771672572LL,
	-1808429243461201518LL, 7990420780896957397LL,  4317817392807076702LL,  3625184369705367340LL,
	-6482649271566653105LL, -3480272027152017464LL, -3225473396345736649LL, -368878695502291645LL,
	-3981164001421868007LL, -8522033136963788610LL, 7609280429197514109LL,  3020985755112334161LL,
	-2572049329799262942LL, 2635195723621160615LL,  5144520864246028816LL,  -8188285521126945980LL,
	1567242097116389047LL,  8172389260191636581LL,  -2885551685425483535LL, -7060359469858316883LL,
	-6480181133964513127LL, -7317004403633452381LL, 6011544915663598137LL,  5932255307352610768LL,
	2241128460406315459LL,  -8327867140638080220LL, 3094483003111372717LL,  4583857460292963101LL,
	9079887171656594975LL,  -384082854924064405LL,  -3460631649611717935LL, 4225072055348026230LL,
	-7385151438465742745LL, 3801620336801580414LL,  -399845416774701952LL,  -7446754431269675473LL,
	7899055018877642622LL,  5421679761463003041LL,  5521102963086275121LL,  -4975092593295409910LL,
	8735487530905098534LL,  -7462844945281082830LL, -2080886987197029914LL, -1000715163927557685LL,
	-4253840471931071485LL, -5828896094657903328LL, 6424174453260338141LL,  359248545074932887LL,
	-5949720754023045210LL, -2426265837057637212LL, 3030918217665093212LL,  -9077771202237461772LL,
	-3186796180789149575LL, 740416251634527158LL,   -2142944401404840226LL, 6951781370868335478LL,
	399922722363687927LL,   -8928469722407522623LL, -1378421100515597285LL, -8343051178220066766LL,
	-3030716356046100229LL, -8811767350470065420LL, 9026808440365124461LL,  6440783557497587732LL,
	4615674634722404292LL,  539897290441580544LL,   2096238225866883852LL,  8751955639408182687LL,
	-7316147128802486205LL, 7381039757301768559LL,  6157238513393239656LL,  -1473377804940618233LL,
	8629571604380892756LL,  5280433031239081479LL,  7101611890139813254LL,  2479018537985767835LL,
	7169176924412769570LL,  -1281305539061572506LL, -7865612307799218120LL, 2278447439451174845LL,
	3625338785743880657LL,  6477479539006708521LL,  8976185375579272206LL,  -3712000482142939688LL,
	1326024180520890843LL,  7537449876596048829LL,  5464680203499696154LL,  3189671183162196045LL,
	6346751753565857109LL,  -8982212049534145501LL, -6127578587196093755LL, -245039190118465649LL,
	-6320577374581628592LL, 7208698530190629697LL,  7276901792339343736LL,  -7490986807540332668LL,
	4133292154170828382LL,  2918308698224194548LL,  -7703910638917631350LL, -3929437324238184044LL,
	-4300543082831323144LL, -6344160503358350167LL, 5896236396443472108LL,  -758328221503023383LL,
	-1894351639983151068LL, -307900319840287220LL,  -6278469401177312761LL, -2171292963361310674LL,
	8382142935188824023LL,  9103922860780351547LL,  4152330101494654406LL,
};

static int32_t seedrand(int32_t x) {
	static const int32_t A = 48271;
	static const int32_t Q = 44488;
	static const int32_t R = 3399;
	int32_t hi = x / Q;
	int32_t lo = x % Q;
	x = (A * lo) - (R * hi);
	if (x < 0) {
		x += INT32_MAX;
	}
	return x;
}

void rand_source_seed(rand_source *rng, int64_t seed) {
	static const int32_t rng_tap = 273;

	rng->tap = 0;
	rng->feed = rng_len - rng_tap;

	seed = seed % INT32_MAX;
	if (seed < 0) {
		seed += INT32_MAX;
	}
	if (seed == 0) {
		seed = 89482311;
	}

	int32_t x = (int32_t)seed;
	for (int i = -20; i < rng_len; i++) {
		x = seedrand(x);
		if (i >= 0) {
			int64_t u;
			u = (int64_t)x << 40;
			x = seedrand(x);
			u ^= (int64_t)x << 20;
			x = seedrand(x);
			u ^= (int64_t)x;
			u ^= rng_cooked[i];
			rng->vec[i] = u;
		}
	}
}

uint64_t rand_source_uint64(rand_source *rng) {
	rng->tap--;
	if (rng->tap < 0) {
		rng->tap += rng_len;
	}

	rng->feed--;
	if (rng->feed < 0) {
		rng->feed += rng_len;
	}

	int64_t x = rng->vec[rng->feed] + rng->vec[rng->tap];
	rng->vec[rng->feed] = x;
	return (uint64_t)x;
}

int64_t rand_source_int64(rand_source *rng) {
	return rand_source_uint64(rng) & INT64_MAX;
}

#define do_locked(fn)                 \
	do {                              \
		pthread_mutex_lock(&mutex);   \
		fn;                           \
		pthread_mutex_unlock(&mutex); \
	} while (0)

void rand_seed(int64_t seed) {
	do_locked(rand_source_seed(&global, seed));
}

uint64_t rand_uint64(void) {
	uint64_t u;
	do_locked(u = rand_source_uint64(&global));
	return u;
}

int64_t rand_int64(void) {
	int64_t n;
	do_locked(n = rand_source_int64(&global));
	return n;
}

static void do_init_rand_seed_once(void) {
	static const uint64_t m1 = UINT64_C(0xa0761d6478bd642f);
	static const uint64_t m2 = UINT64_C(0xe7037ed1a0b428db);
	uint64_t seed;
	if (getentropy((void *)&seed, sizeof(uint64_t)) != 0) {
		struct timeval tv;
		gettimeofday(&tv, NULL);
		seed = (getpid() << 16) ^ ((uint64_t)tv.tv_sec * m1) ^ (tv.tv_usec * m2);
	}
	rand_seed(seed);
}

void rand_init_seed_once(void) {
	pthread_once(&once, do_init_rand_seed_once);
}
